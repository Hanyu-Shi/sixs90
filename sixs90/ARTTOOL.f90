!    Kokhanovsky, A. A., & Breon, F.-M. (2012). Validation of an Analytical Snow
!       BRDF Model Using PARASOL Multi-Angular and Multispectral Observations.
!       IEEE Geoscience and Remote Sensing Letters, 9(5), 928¨C932.


module art_module
!    Warren, S. G. (1984). Optical constants of ice from the ultraviolet to the
!       microwave. Applied Optics, 23(8), 1206.

    implicit none
    integer, parameter :: nw = 161 ! 400-2500 nm
    real(8) :: m_im(nw), lambda(nw) ! m_im is the imaginary part of ice refractive index
    integer :: i

        DATA (lambda(i),i=1,nw)/&
    400.d0, 410.d0, 420.d0, 430.d0, 440.d0, 450.d0, &
    460.d0, 470.d0, 480.d0, 490.d0, 500.d0, 510.d0, &
    520.d0, 530.d0, 540.d0, 550.d0, 560.d0, 570.d0, &
    580.d0, 590.d0, 600.d0, 610.d0, 620.d0, 630.d0, &
    640.d0, 650.d0, 660.d0, 670.d0, 680.d0, 690.d0, &
    700.d0, 710.d0, 720.d0, 730.d0, 740.d0, 750.d0, &
    760.d0, 770.d0, 780.d0, 790.d0, 800.d0, 810.d0, &
    820.d0, 830.d0, 840.d0, 850.d0, 860.d0, 870.d0, &
    880.d0, 890.d0, 900.d0, 910.d0, 920.d0, 930.d0, &
    940.d0, 950.d0, 960.d0, 970.d0, 980.d0, 990.d0, &
    1000.d0, 1010.d0, 1020.d0, 1030.d0, 1040.d0, 1050.d0, &
    1060.d0, 1070.d0, 1080.d0, 1090.d0, 1100.d0, 1110.d0, &
    1120.d0, 1130.d0, 1140.d0, 1150.d0, 1160.d0, 1170.d0, &
    1180.d0, 1190.d0, 1200.d0, 1210.d0, 1220.d0, 1230.d0, &
    1240.d0, 1250.d0, 1260.d0, 1270.d0, 1280.d0, 1290.d0, &
    1300.d0, 1310.d0, 1320.d0, 1330.d0, 1340.d0, 1350.d0, &
    1360.d0, 1370.d0, 1380.d0, 1390.d0, 1400.d0, 1410.d0, &
    1420.d0, 1430.d0, 1440.d0, 1450.d0, 1460.d0, 1471.d0, &
    1481.d0, 1493.d0, 1504.d0, 1515.d0, 1527.d0, 1538.d0, &
    1563.d0, 1587.d0, 1613.d0, 1650.d0, 1680.d0, 1700.d0, &
    1730.d0, 1760.d0, 1800.d0, 1830.d0, 1840.d0, 1850.d0, &
    1855.d0, 1860.d0, 1870.d0, 1890.d0, 1905.d0, 1923.d0, &
    1942.d0, 1961.d0, 1980.d0, 2000.d0, 2020.d0, 2041.d0, &
    2062.d0, 2083.d0, 2105.d0, 2130.d0, 2150.d0, 2170.d0, &
    2190.d0, 2220.d0, 2240.d0, 2245.d0, 2250.d0, 2260.d0, &
    2270.d0, 2290.d0, 2310.d0, 2330.d0, 2350.d0, 2370.d0, &
    2390.d0, 2410.d0, 2430.d0, 2460.d0, 2500.d0/

    ! imaginary parts of the complex index of refraction of ice
        DATA (m_im(i),i= 1, nw)/&
    2.710d-9, 2.510d-9, 2.260d-9, 2.080d-9, 1.910d-9, 1.540d-9, &
    1.530d-9, 1.550d-9, 1.640d-9, 1.780d-9, 1.910d-9, 2.140d-9, &
    2.260d-9, 2.540d-9, 2.930d-9, 3.110d-9, 3.290d-9, 3.520d-9, &
    4.040d-9, 4.880d-9, 5.730d-9, 6.890d-9, 8.580d-9, 1.040d-8, &
    1.220d-8, 1.430d-8, 1.660d-8, 1.890d-8, 2.090d-8, 2.400d-8, &
    2.900d-8, 3.440d-8, 4.030d-8, 4.300d-8, 4.920d-8, 5.870d-8, &
    7.080d-8, 8.580d-8, 1.020d-7, 1.180d-7, 1.340d-7, 1.400d-7, &
    1.430d-7, 1.450d-7, 1.510d-7, 1.830d-7, 2.150d-7, 2.650d-7, &
    3.350d-7, 3.920d-7, 4.200d-7, 4.440d-7, 4.740d-7, 5.110d-7, &
    5.530d-7, 6.020d-7, 7.550d-7, 9.260d-7, 1.120d-6, 1.330d-6, &
    1.620d-6, 2.000d-6, 2.250d-6, 2.330d-6, 2.330d-6, 2.170d-6, &
    1.960d-6, 1.810d-6, 1.740d-6, 1.730d-6, 1.700d-6, 1.760d-6, &
    1.820d-6, 2.040d-6, 2.250d-6, 2.290d-6, 3.040d-6, 3.840d-6, &
    4.770d-6, 5.760d-6, 6.710d-6, 8.660d-6, 1.020d-5, 1.130d-5, &
    1.220d-5, 1.290d-5, 1.320d-5, 1.350d-5, 1.330d-5, 1.320d-5, &
    1.320d-5, 1.310d-5, 1.320d-5, 1.320d-5, 1.340d-5, 1.390d-5, &
    1.420d-5, 1.480d-5, 1.580d-5, 1.740d-5, 1.980d-5, 2.500d-5, &
    5.400d-5, 1.040d-4, 2.030d-4, 2.708d-4, 3.511d-4, 4.299d-4, &
    5.181d-4, 5.855d-4, 5.899d-4, 5.635d-4, 5.480d-4, 5.266d-4, &
    4.394d-4, 3.701d-4, 3.372d-4, 2.410d-4, 1.890d-4, 1.660d-4, &
    1.450d-4, 1.280d-4, 1.030d-4, 8.600d-5, 8.220d-5, 8.030d-5, &
    8.500d-5, 9.900d-5, 1.500d-4, 2.950d-4, 4.687d-4, 7.615d-4, &
    1.010d-3, 1.313d-3, 1.539d-3, 1.588d-3, 1.540d-3, 1.412d-3, &
    1.244d-3, 1.068d-3, 8.414d-4, 5.650d-4, 4.320d-4, 3.500d-4, &
    2.870d-4, 2.210d-4, 2.030d-4, 2.010d-4, 2.030d-4, 2.140d-4, &
    2.320d-4, 2.890d-4, 3.810d-4, 4.620d-4, 5.480d-4, 6.180d-4, &
    6.800d-4, 7.300d-4, 7.820d-4, 8.480d-4, 9.250d-4/

end module

subroutine ART(sza,vza,phi,dia,M,wl,refl)
    use art_module, only : lambda,m_im
    implicit none
    real(8), intent(in) :: sza, vza, phi, dia, M, wl  ! sza, vza, phi in radian
    real(8), intent(out) :: refl

    real(8), parameter :: dr = acos(-1.d0) / 180.0
    real(8) :: theta,p_theta,R0,mu_s,mu_v,Ks,Kv,alpha,r,L
    integer :: ipos(1)

    if (wl<400.d0 .or. wl>2500.d0) stop "wavelength out of range, in ART."

    mu_s = cos(sza)
    mu_v = cos(vza)

    theta = acos(-mu_s*mu_v + sin(sza)*sin(vza)*cos(phi)) / dr
    p_theta = 11.1*exp(-0.087*theta) + 1.1*exp(-0.014*theta)
    R0 = 0.25* ((1.247 + 5.157*mu_s*mu_v + p_theta) / (mu_s+mu_v) + 1.186)

    Ks = 3.0*(1+2*mu_s) / 7.0
    Kv = 3.0*(1+2*mu_v) / 7.0

    ipos = minloc(abs(lambda - wl))

    r = 4.0*cos(-1.d0)*(m_im(ipos(1))+M) / lambda(ipos(1))
    L = 13.0*dia*1000.0
    alpha = sqrt(r*L)

    refl = R0*exp(-alpha*Ks*Kv/R0)

end subroutine
